- name: provider templates
  template:
    src: "{{item}}-provider.j2"
    dest: "{{workdir}}00-provider-{{item}}.tf"
  with_items: "{{terraform_providers|default(['aws'])}}"

- name: remote states
  template:
    src: "remotestate.j2"
    dest: "{{workdir}}01-remotestate.tf"

- name: concat nic lists
  set_fact:
    _mynic: "{{_mynic|default([])+(item.nic|default([]))}}"
  with_items: "{{vms|list}}"

- name: import state from other terraform projects
  template:
    src: "importstate.j2"
    dest: "{{workdir}}02-importstate.tf"
  vars:
    allsubnets: "{{(_mynic|default([]) + common.nic|default([]))|map(attribute='subnet')|unique()|list}}"

- name: local variables
  template:
    src: "locals.j2"
    dest: "{{workdir}}03-locals.tf"

- name: define security groups
  template:
    src: aws_security_groups.j2
    dest: "{{workdir}}10-security_groups.tf"
  when:
    security_groups is defined

- name: IAM resources
  template:
    src: aws_roles.j2
    dest: "{{workdir}}11-iam_resources.tf"
  when:
    iam_roles is defined or instance_profiles is defined

- name: policy files
  template:
    src: "{{item}}"
    dest: "{{workdir}}{{item}}"
  with_items:
  - ec2_assume_role_policy.json

- name: instances
  template:
    src: aws_instance.j2
    dest: "{{workdir}}20-server-{{item.name}}.tf"
  with_items: "[{{vms|default([])|list()}}]"
